<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>å¤§é˜ªå®¶æ—æ—…è¡Œ 2026</title>
  
  <meta name="theme-color" content="#750000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="å¤§é˜ªæ—…è¡Œ">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/826/826070.png">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    body {
      font-family: 'Noto Sans TC', sans-serif;
      -webkit-tap-highlight-color: transparent;
      background-color: #F9FAFB;
      margin: 0; padding: 0;
      height: 100dvh; overflow: hidden;
      font-size: 18px;
    }
    #root { height: 100%; display: flex; flex-direction: column; }
    .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
  </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^18.2.0",
    "react/": "https://esm.sh/react@^18.2.0/",
    "@google/genai": "https://esm.sh/@google/genai@^1.38.0"
  }
}
</script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-presets="react">

    const { useState, useEffect, useRef } = React;

    // --- åˆå§‹è³‡æ–™èˆ‡å¸¸æ•¸ ---
    const TRIP_START_DATE = '2026-02-11';
    const TRIP_END_DATE = '2026-02-18';
    const FLIGHT_INFO = {
      outbound: { time: '14:40 - 17:55' },
      inbound: { time: '11:30 - 13:50' }
    };

    const ACCOMMODATIONS = [
      { date: '2026-02-11', name: 'HATAGO INN é—œè¥¿æ©Ÿå ´', subName: 'ãƒã‚¿ã‚´ã‚¤ãƒ³é–¢è¥¿ç©ºæ¸¯', location: 'å¤§é˜ª', url: 'https://maps.app.goo.gl/MT8TnZ8oaFrfkuSbA' },
      { date: '2026-02-12', name: 'äº¬éƒ½å®®æ´¥ç¾å±…æº«æ³‰åº¦å‡é…’åº—', subName: 'Mercure Kyoto Miyazu', location: 'å¤©æ©‹ç«‹', url: 'https://maps.app.goo.gl/3SZhPn8AheqhYG3P8' },
      { date: '2026-02-13', name: 'Green Rich Hotel Tottori Ekimae', subName: 'ã‚°ãƒªãƒ¼ãƒ³ãƒªãƒƒãƒãƒ›ãƒ†ãƒ«é³¥å–é§…å‰', location: 'é³¥å–', url: 'https://maps.app.goo.gl/qr55npTNcgJCyqd8A' },
      { date: '2026-02-14', name: 'The OneFive Garden Kurashiki', subName: 'ã‚¶ãƒ»ãƒ¯ãƒ³ãƒ•ã‚¡ã‚¤ãƒ–ã‚¬ãƒ¼ãƒ‡ãƒ³å€‰æ•·', location: 'å€‰æ•·', url: 'https://maps.app.goo.gl/VJBdSAt5Sj6zp4dU7' },
      { date: '2026-02-15', name: 'æ±æ©«INN é«˜æ¾ç«™å‰', subName: 'æ±æ¨ªINNé«˜æ¾é§…å‰', location: 'é«˜æ¾', url: 'https://maps.app.goo.gl/775LGmzj7GMh3J676' },
      { date: '2026-02-16', name: 'ç¥æˆ¶ è¥¿ç¥æ±æ–¹é£¯åº—', subName: 'ç¥æˆ¸ è¥¿ç¥ã‚ªãƒªã‚¨ãƒ³ã‚¿ãƒ«ãƒ›ãƒ†ãƒ«', location: 'ç¥æˆ¶', url: 'https://maps.app.goo.gl/nGGcXvDpDYkbPX1v6' },
      { date: '2026-02-17', name: 'é—œè¥¿æ©Ÿå ´è¯ç››é “é…’åº—', subName: 'é–¢è¥¿ã‚¨ã‚¢ãƒãƒ¼ãƒˆãƒ¯ã‚·ãƒ³ãƒˆãƒ³ãƒ›ãƒ†ãƒ«', location: 'å’Œæ­Œå±±', url: 'https://maps.app.goo.gl/C3fbMMABRxUWF6u17' },
      { date: '2026-02-18', name: 'é—œè¥¿æ©Ÿå ´è¯ç››é “é…’åº—', subName: '(çºŒä½)', location: 'å¤§é˜ª', url: 'https://maps.app.goo.gl/C3fbMMABRxUWF6u17' }
    ];

    const INITIAL_ITINERARY = ACCOMMODATIONS.map(acc => {
      let acts = [];
      if (acc.date === '2026-02-11') {
        acts.push({ id: 'f1', title: 'æŠµé”é—œè¥¿æ©Ÿå ´', category: 'å…¶ä»–', image: null });
      }
      if (acc.date === '2026-02-15') {
        acts.push({ id: 'boat-1', title: 'æ­èˆ¹å¾€ç›´å³¶', category: 'ç©', image: null });
      }
      return {
        date: acc.date,
        accommodation: acc,
        activities: acts,
        reminder: ''
      };
    });

    // --- ç°¡åŒ–åœ–ç¤º ---
    const PencilIcon = () => (
      <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
        <path d="M12 20h9M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z" />
      </svg>
    );

    const CloseIcon = () => (
      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="3">
        <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
      </svg>
    );

    const ChevronIcon = ({ direction = "up" }) => (
      <svg className={`w-4 h-4 ${direction === "down" ? "rotate-180" : ""}`} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round">
        <path d="M18 15l-6-6-6 6" />
      </svg>
    );

    // --- å­çµ„ä»¶ï¼šå°è¦½åˆ— ---
    const TabBar = ({ activeTab, onTabChange }) => {
      const tabs = [
        { id: 'home', label: 'é¦–é ', icon: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6' },
        { id: 'schedule', label: 'è¡Œç¨‹', icon: 'M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z' },
        { id: 'shopping', label: 'è³¼ç‰©', icon: 'M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z' }
      ];
      return (
        <nav className="fixed bottom-0 w-full max-w-md bg-white/90 backdrop-blur-lg border-t border-gray-200 safe-area-bottom z-50">
          <div className="flex justify-around items-center h-16 px-2">
            {tabs.map(tab => (
              <button key={tab.id} onClick={() => onTabChange(tab.id)} className={`flex flex-col items-center flex-1 transition-all ${activeTab === tab.id ? 'text-[#750000] scale-110' : 'text-gray-300'}`}>
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={activeTab === tab.id ? 2.5 : 2} d={tab.icon} /></svg>
                <span className="text-[10px] font-black mt-0.5">{tab.label}</span>
              </button>
            ))}
          </div>
        </nav>
      );
    };

    // --- å­çµ„ä»¶ï¼šé¦–é  ---
    const HomeView = ({ itinerary }) => {
      const today = new Date();
      const tripStart = new Date(TRIP_START_DATE);
      const diff = Math.ceil((tripStart - today) / (1000 * 60 * 60 * 24));
      
      return (
        <div className="px-5 py-8 space-y-8 animate-fadeIn pb-10">
          <header>
            <p className="text-xs font-black text-[#750000] uppercase mb-1">{today.toLocaleDateString('zh-TW', { weekday: 'long', month: 'long', day: 'numeric' })}</p>
            <h1 className="text-3xl font-black text-gray-900 leading-snug tracking-tighter">å¤§é˜ªå®¶æ—æ—…è¡Œ 2026</h1>
          </header>

          <section className="bg-[#750000] text-white rounded-[2.5rem] py-12 px-8 text-center shadow-2xl shadow-[#750000]/20 relative overflow-hidden">
            <p className="text-lg font-black opacity-70 mb-2 uppercase tracking-widest relative z-10">è·é›¢å‡ºç™¼é‚„æœ‰</p>
            <div className="flex items-baseline justify-center gap-2 relative z-10">
              <span className="text-8xl font-black tracking-tighter">{diff > 0 ? diff : 'âœ“'}</span>
              <span className="text-2xl font-black opacity-60 uppercase tracking-normal">{diff > 0 ? 'Days' : 'Done'}</span>
            </div>
          </section>

          <div className="grid grid-cols-2 gap-4">
            <div className="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm">
              <span className="text-[10px] font-black text-gray-400 uppercase block mb-1 tracking-widest">å»ç¨‹èˆªç­</span>
              <p className="text-lg font-black text-slate-900 tracking-tighter">{FLIGHT_INFO.outbound.time}</p>
            </div>
            <div className="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm">
              <span className="text-[10px] font-black text-gray-400 uppercase block mb-1 tracking-widest">å›ç¨‹èˆªç­</span>
              <p className="text-lg font-black text-slate-900 tracking-tighter">{FLIGHT_INFO.inbound.time}</p>
            </div>
          </div>
        </div>
      );
    };

    // --- å­çµ„ä»¶ï¼šè¡Œç¨‹è¡¨ ---
    const ScheduleView = ({ itinerary, onUpdate }) => {
      const [selected, setSelected] = useState(itinerary[0].date);
      const [showAdd, setShowAdd] = useState(false);
      const [showNote, setShowNote] = useState(false);
      const [newAct, setNewAct] = useState({ title: '', mapsUrl: '', category: 'ç©', image: null });
      const [deletingId, setDeletingId] = useState(null);
      const [editingId, setEditingId] = useState(null);
      const [editAct, setEditAct] = useState({ title: '', mapsUrl: '', category: 'ç©', image: null });
      const [expandedIds, setExpandedIds] = useState(new Set());
      const [tempNote, setTempNote] = useState('');
      const fileInputRef = useRef(null);
      const editFileInputRef = useRef(null);

      const day = itinerary.find(d => d.date === selected);

      const toggleExpand = (id) => {
        const next = new Set(expandedIds);
        if (next.has(id)) next.delete(id);
        else next.add(id);
        setExpandedIds(next);
      };

      const handleImageUpload = (e, target) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => {
            if (target === 'new') setNewAct(prev => ({ ...prev, image: reader.result }));
            else setEditAct(prev => ({ ...prev, image: reader.result }));
          };
          reader.readAsDataURL(file);
        }
      };

      const addAct = () => {
        if (!newAct.title) return;
        const acts = [...day.activities, { id: Date.now().toString(), ...newAct }];
        onUpdate(itinerary.map(d => d.date === selected ? { ...d, activities: acts } : d));
        setNewAct({ title: '', mapsUrl: '', category: 'ç©', image: null });
        setShowAdd(false);
      };

      const delAct = (id) => {
        if (deletingId === id) {
          onUpdate(itinerary.map(d => d.date === selected ? { ...d, activities: d.activities.filter(a => a.id !== id) } : d));
          setDeletingId(null);
        } else {
          setDeletingId(id);
          setTimeout(() => setDeletingId(null), 3000);
        }
      };

      const startEdit = (a) => {
        setEditingId(a.id);
        setEditAct({ title: a.title, mapsUrl: a.mapsUrl || '', category: a.category || 'ç©', image: a.image || null });
      };

      const saveEdit = () => {
        const acts = day.activities.map(a => a.id === editingId ? { ...a, ...editAct } : a);
        onUpdate(itinerary.map(d => d.date === selected ? { ...d, activities: acts } : d));
        setEditingId(null);
      };

      const moveAct = (index, direction) => {
        const newActivities = [...day.activities];
        const targetIndex = direction === 'up' ? index - 1 : index + 1;
        if (targetIndex < 0 || targetIndex >= newActivities.length) return;
        
        [newActivities[index], newActivities[targetIndex]] = [newActivities[targetIndex], newActivities[index]];
        onUpdate(itinerary.map(d => d.date === selected ? { ...d, activities: newActivities } : d));
      };

      const saveNote = () => {
        onUpdate(itinerary.map(d => d.date === selected ? { ...d, reminder: tempNote } : d));
        setShowNote(false);
      };

      const getCatColor = (c) => {
        if (c === 'é£Ÿ') return 'bg-red-50 text-red-600 border-red-100';
        if (c === 'ç©') return 'bg-blue-50 text-blue-600 border-blue-100';
        if (c === 'è²·') return 'bg-orange-50 text-orange-600 border-orange-100';
        return 'bg-gray-100 text-gray-400 border-gray-200';
      };

      return (
        <div className="pb-24 animate-fadeIn">
          <div className="sticky top-0 bg-white/95 backdrop-blur-md z-30 px-4 py-4 border-b border-gray-100 flex justify-between items-center">
             <h2 className="text-2xl font-black tracking-tighter">è¡Œç¨‹è¦åŠƒ</h2>
             <button onClick={() => { setTempNote(day.reminder || ''); setShowNote(true); }} className="bg-[#F5F5F0] text-[#750000] px-4 py-2 rounded-xl text-sm font-black border border-[#E5E5DE]">å‚™è¨»</button>
          </div>

          <div className="bg-white/90 backdrop-blur-md px-4 py-2 flex gap-2 overflow-x-auto no-scrollbar border-b border-gray-50 sticky top-[73px] z-20">
            {itinerary.map(d => (
              <button key={d.date} onClick={() => { setSelected(d.date); setEditingId(null); }} className={`flex flex-col items-center min-w-[75px] py-2 rounded-xl border transition-all ${selected === d.date ? 'bg-[#750000] border-[#750000] text-white shadow-md' : 'bg-gray-50 border-gray-50 text-gray-400'}`}>
                <span className="text-xs font-black">{d.date.slice(5)}</span>
                <span className="text-sm font-black tracking-tight">{d.accommodation.location}</span>
              </button>
            ))}
          </div>

          <div className="px-4 py-6 space-y-4">
            {day.reminder && (
              <div className="bg-[#F5F5F0] p-4 rounded-2xl border border-[#E5E5DE] flex items-center gap-3">
                <span className="text-xl">ğŸ””</span>
                <p className="font-bold text-slate-700 text-lg leading-snug">{day.reminder}</p>
              </div>
            )}

            <div className="bg-white rounded-[2rem] p-6 border border-gray-100 shadow-sm">
              <span className="text-[10px] font-black text-gray-400 uppercase block mb-2 tracking-widest">ä½å®¿é£¯åº—</span>
              <h3 className="text-xl font-black text-slate-900 leading-tight">{day.accommodation.name}</h3>
              <p className="text-xs font-bold text-gray-400 mt-1">{day.accommodation.subName}</p>
              <a href={day.accommodation.url} target="_blank" className="mt-6 w-full py-4 bg-[#750000] text-white rounded-2xl flex items-center justify-center gap-2 font-black shadow-lg shadow-[#750000]/20 text-lg">å°èˆª</a>
            </div>

            <div className="flex justify-between items-center pt-4">
              <h4 className="text-xl font-black tracking-tighter uppercase text-slate-400">è¡Œç¨‹å…§å®¹</h4>
              <button onClick={() => setShowAdd(true)} className="w-14 h-14 bg-[#750000] text-white rounded-full flex items-center justify-center text-3xl font-light shadow-lg active:scale-90 transition-transform">+</button>
            </div>

            <div className="space-y-4">
              {day.activities.map((a, i) => {
                const isExpanded = expandedIds.has(a.id);
                const isEditing = editingId === a.id;
                
                return (
                  <div key={a.id} className={`bg-white rounded-3xl border flex flex-col transition-all overflow-hidden ${deletingId === a.id ? 'border-red-400 bg-red-50' : 'border-gray-100 shadow-sm'}`}>
                    <div className="p-4 space-y-3">
                      {isEditing ? (
                        <div className="space-y-4 animate-fadeIn">
                          <div className="flex gap-2">
                            {['é£Ÿ','ç©','è²·','å…¶ä»–'].map(c => (
                              <button key={c} onClick={() => setEditAct({...editAct, category: c})} className={`flex-1 py-3 rounded-xl font-black border transition-all ${editAct.category === c ? 'bg-[#750000] text-white border-[#750000]' : 'bg-gray-50 text-gray-400'}`}>{c}</button>
                            ))}
                          </div>
                          <input value={editAct.title} onChange={e => setEditAct({...editAct, title: e.target.value})} className="w-full bg-gray-50 border-2 border-gray-100 rounded-xl p-4 font-black outline-none focus:border-[#750000] text-lg" placeholder="åœ°é»åç¨±" />
                          <input value={editAct.mapsUrl} onChange={e => setEditAct({...editAct, mapsUrl: e.target.value})} className="w-full bg-gray-50 border-2 border-gray-100 rounded-xl p-4 font-black outline-none focus:border-[#750000] text-lg" placeholder="åœ°åœ–é€£çµ" />
                          <div className="flex gap-2">
                            <button onClick={() => setEditingId(null)} className="flex-1 py-4 font-black text-gray-400">å–æ¶ˆ</button>
                            <button onClick={saveEdit} className="flex-[2] py-4 bg-[#750000] text-white rounded-xl font-black shadow-lg">å„²å­˜ä¿®æ”¹</button>
                          </div>
                        </div>
                      ) : (
                        <div className="flex items-center gap-3">
                          <span className={`px-4 py-1 rounded-xl text-base font-black border shrink-0 ${getCatColor(a.category)}`}>{a.category}</span>
                          <div className="flex-1 min-w-0" onClick={() => toggleExpand(a.id)}>
                            <p className={`font-black text-xl leading-snug tracking-tighter ${isExpanded ? '' : 'truncate'}`}>{a.title}</p>
                          </div>
                          
                          <div className="flex gap-2 shrink-0 items-center">
                            {/* æ’åºæŒ‰éˆ• */}
                            <div className="flex flex-col gap-1 pr-1 border-r border-gray-50">
                                {i > 0 && (
                                    <button onClick={(e) => { e.stopPropagation(); moveAct(i, 'up'); }} className="p-1.5 text-gray-300 active:text-[#750000]"><ChevronIcon direction="up"/></button>
                                )}
                                {i < day.activities.length - 1 && (
                                    <button onClick={(e) => { e.stopPropagation(); moveAct(i, 'down'); }} className="p-1.5 text-gray-300 active:text-[#750000]"><ChevronIcon direction="down"/></button>
                                )}
                            </div>
                            {/* åŠŸèƒ½æŒ‰éˆ• */}
                            <div className="flex items-center gap-1">
                                <button onClick={() => startEdit(a)} className="p-2 text-[#750000] bg-red-50 rounded-xl active:scale-90 transition-transform"><PencilIcon /></button>
                                <button onClick={() => delAct(a.id)} className={`p-2 rounded-xl active:scale-90 transition-transform ${deletingId === a.id ? 'bg-red-500 text-white' : 'text-gray-200'}`}><CloseIcon /></button>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                    {isExpanded && !isEditing && (
                      <div className="px-4 pb-5 space-y-4 animate-fadeIn border-t border-gray-50 pt-4">
                        {a.image && <img src={a.image} className="w-full rounded-[2rem] border shadow-sm" />}
                        {a.mapsUrl && <a href={a.mapsUrl} target="_blank" className="w-full py-4 bg-slate-900 text-white rounded-2xl text-center block font-black text-lg active:scale-95 transition-transform">é–‹å•Ÿåœ°åœ–</a>}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          </div>

          {/* æ–°å¢å½ˆçª— */}
          {showAdd && (
            <div className="fixed inset-0 bg-black/60 z-[100] flex items-end animate-fadeIn">
              <div className="bg-white w-full rounded-t-[2.5rem] p-8 space-y-6 pb-20 overflow-y-auto max-h-[90vh]">
                <h3 className="text-2xl font-black">æ–°å¢è¡Œç¨‹åœ°é»</h3>
                <div className="flex gap-2">
                  {['é£Ÿ','ç©','è²·','å…¶ä»–'].map(c => (
                    <button key={c} onClick={() => setNewAct({...newAct, category: c})} className={`flex-1 py-4 rounded-xl font-black border text-lg transition-all ${newAct.category === c ? 'bg-[#750000] text-white border-[#750000]' : 'bg-gray-50 text-gray-400'}`}>{c}</button>
                  ))}
                </div>
                <div className="flex gap-3">
                  <input value={newAct.title} onChange={e => setNewAct({...newAct, title: e.target.value})} className="flex-1 bg-gray-50 border-2 border-gray-100 rounded-2xl p-4 font-black outline-none focus:border-[#750000] text-lg" placeholder="åœ°é»åç¨±" />
                  <button onClick={() => fileInputRef.current.click()} className={`w-16 h-16 rounded-2xl border-2 border-dashed flex items-center justify-center shrink-0 ${newAct.image ? 'border-[#750000] bg-red-50' : 'border-gray-200'}`}>
                    {newAct.image ? <img src={newAct.image} className="w-full h-full object-cover rounded-xl" /> : <span className="text-2xl text-gray-300">+</span>}
                  </button>
                  <input type="file" ref={fileInputRef} onChange={e => handleImageUpload(e, 'new')} className="hidden" accept="image/*" />
                </div>
                <input value={newAct.mapsUrl} onChange={e => setNewAct({...newAct, mapsUrl: e.target.value})} className="w-full bg-gray-50 border-2 border-gray-100 rounded-2xl p-4 font-black outline-none focus:border-[#750000] text-lg" placeholder="åœ°åœ–ç¶²å€ (é¸å¡«)" />
                <div className="flex gap-4">
                  <button onClick={() => setShowAdd(false)} className="flex-1 py-4 font-black text-gray-400 text-lg">å–æ¶ˆ</button>
                  <button onClick={addAct} className="flex-[2] py-4 bg-[#750000] text-white rounded-2xl font-black shadow-lg text-lg">ç¢ºèªæ–°å¢</button>
                </div>
              </div>
            </div>
          )}

          {/* å‚™è¨»å½ˆçª— */}
          {showNote && (
            <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-6 animate-fadeIn">
              <div className="bg-white w-full rounded-[2.5rem] p-8 space-y-6 shadow-2xl">
                <h3 className="text-2xl font-black">ä¿®æ”¹ä»Šæ—¥å‚™è¨»</h3>
                <textarea value={tempNote} onChange={e => setTempNote(e.target.value)} className="w-full bg-gray-50 border-2 border-gray-100 rounded-[1.5rem] p-5 font-bold text-lg min-h-[150px] outline-none focus:border-[#750000]" placeholder="è¼¸å…¥é‡é»..." />
                <div className="flex gap-4">
                  <button onClick={() => setShowNote(false)} className="flex-1 font-black text-gray-400 text-lg">å–æ¶ˆ</button>
                  <button onClick={saveNote} className="flex-[2] py-4 bg-[#750000] text-white rounded-2xl font-black shadow-lg text-lg">å„²å­˜ä¿®æ”¹</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // --- å­çµ„ä»¶ï¼šè³¼ç‰©æ¸…å–® ---
    const ShoppingView = ({ personal, proxy, setPersonal, setProxy, categories, setCategories }) => {
      const [type, setType] = useState('personal');
      const [filter, setFilter] = useState('å…¨éƒ¨');
      const [input, setInput] = useState({ name: '', price: '', category: categories[0] || 'è—¥å¦åº—', img: null });
      const [showManage, setShowManage] = useState(false);
      const [newCat, setNewCat] = useState('');
      const [expandedImg, setExpandedImg] = useState(null);
      const fileRef = useRef(null);

      const list = type === 'personal' ? personal : proxy;
      const setList = type === 'personal' ? setPersonal : setProxy;
      const filtered = filter === 'å…¨éƒ¨' ? list : list.filter(i => i.category === filter);

      const add = () => {
        if (!input.name) return;
        setList([...list, { id: Date.now().toString(), ...input, done: false }]);
        setInput({ name: '', price: '', category: input.category, img: null });
      };

      const handleImg = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => setInput({...input, img: reader.result});
          reader.readAsDataURL(file);
        }
      };

      const addNewCategory = () => {
        const trimmed = newCat.trim();
        if (trimmed && !categories.includes(trimmed)) {
          setCategories([...categories, trimmed]);
          setNewCat('');
        }
      };

      return (
        <div className="px-5 py-8 space-y-6 animate-fadeIn pb-28">
          <h2 className="text-3xl font-black tracking-tighter text-slate-900">è³¼ç‰©è»Š</h2>
          
          <div className="flex p-1.5 bg-gray-100 rounded-2xl">
            <button onClick={() => setType('personal')} className={`flex-1 py-4 rounded-xl font-black text-lg transition-all ${type === 'personal' ? 'bg-white shadow-sm text-[#750000]' : 'text-gray-400'}`}>è³¼ç‰©</button>
            <button onClick={() => setType('proxy')} className={`flex-1 py-4 rounded-xl font-black text-lg transition-all ${type === 'proxy' ? 'bg-white shadow-sm text-[#965454]' : 'text-gray-400'}`}>ä»£è³¼</button>
          </div>

          <div className="bg-white p-6 rounded-[2.5rem] border border-gray-100 shadow-sm space-y-5">
            <div className="flex gap-2 items-center">
              <input value={input.name} onChange={e => setInput({...input, name: e.target.value})} className="flex-1 min-w-0 bg-gray-50 border-2 border-gray-50 rounded-2xl p-4 font-bold h-14 outline-none text-lg" placeholder="å•†å“åç¨±" />
              <button onClick={() => fileRef.current.click()} className={`w-14 h-14 rounded-2xl border-2 border-dashed flex items-center justify-center shrink-0 transition-all ${input.img ? 'border-[#750000] bg-[#F5F5F0] text-[#750000]' : 'border-gray-200 text-gray-300'}`}>
                <span className="text-2xl font-black">+</span>
              </button>
              <input type="file" ref={fileRef} onChange={handleImg} className="hidden" accept="image/*" />
            </div>
            
            <div className="flex gap-2 h-14">
              <div className="relative flex-[2] h-full">
                <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs font-black">NT$</span>
                <input type="number" value={input.price} onChange={e => setInput({...input, price: e.target.value})} className="w-full h-full bg-gray-50 border-2 border-gray-50 rounded-2xl p-4 pl-12 font-bold outline-none text-lg" placeholder="åƒ¹æ ¼" />
              </div>
              <div className="flex-[3] flex gap-2 h-full">
                <select value={input.category} onChange={e => setInput({...input, category: e.target.value})} className="flex-1 h-full bg-gray-50 border-2 border-gray-50 rounded-2xl px-3 font-bold appearance-none text-lg outline-none">
                  {categories.map(c => <option key={c} value={c}>{c}</option>)}
                </select>
                <button onClick={() => setShowManage(true)} className="w-14 h-full bg-gray-100 rounded-2xl text-slate-400 font-black shrink-0 flex items-center justify-center active:scale-90 transition-transform"><span className="text-2xl">âš™</span></button>
              </div>
            </div>
            
            <button onClick={add} className={`w-full py-5 text-white rounded-[1.5rem] font-black text-xl shadow-lg active:scale-95 transition-all ${type === 'personal' ? 'bg-[#750000] shadow-[#750000]/20' : 'bg-[#965454] shadow-[#965454]/20'}`}>æ–°å¢åˆ°æ¸…å–®</button>
            {input.img && <img src={input.img} className="h-24 w-24 object-cover rounded-2xl mt-2 border-2 border-white shadow-md" />}
          </div>

          <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2">
            <button onClick={() => setFilter('å…¨éƒ¨')} className={`px-6 py-3 rounded-full font-black text-base shrink-0 transition-all ${filter === 'å…¨éƒ¨' ? 'bg-slate-900 text-white shadow-md' : 'bg-white border border-gray-100 text-gray-400'}`}>å…¨éƒ¨é …ç›®</button>
            {categories.map(c => <button key={c} onClick={() => setFilter(c)} className={`px-6 py-3 rounded-full font-black text-base shrink-0 transition-all ${filter === c ? 'bg-[#EAD9D9] text-[#750000] shadow-sm' : 'bg-white border border-gray-100 text-gray-400'}`}>{c}</button>)}
          </div>

          <div className="space-y-3">
            {filtered.map(i => (
              <div key={i.id} className="space-y-2">
                <div className={`flex items-center gap-4 p-5 rounded-[2.5rem] border transition-all ${i.done ? 'bg-gray-50 border-transparent opacity-50' : 'bg-white border-gray-100 shadow-sm'}`}>
                  <button onClick={() => setList(list.map(x => x.id === i.id ? {...x, done: !x.done} : x))} className={`w-11 h-11 rounded-full border-[4px] flex items-center justify-center shrink-0 transition-all ${i.done ? 'bg-[#750000] border-[#750000]' : 'border-gray-200 bg-white'}`}>
                    {i.done && <span className="text-white text-lg font-black">âœ“</span>}
                  </button>
                  <div className="flex-1 min-w-0" onClick={() => i.img && setExpandedImg(expandedImg === i.id ? null : i.id)}>
                    <div className="flex items-center gap-2">
                      <p className={`text-xl font-black truncate tracking-tighter ${i.done ? 'line-through text-gray-400' : 'text-slate-900'}`}>{i.name}</p>
                     
                    </div>
                    {i.price && <p className="text-base font-black text-[#750000] mt-1 opacity-70">NT$ {i.price}</p>}
                  </div>
                  {i.img && <span className="text-2xl shrink-0">ğŸ–¼ï¸</span>}
                  <button onClick={() => setList(list.filter(x => x.id !== i.id))} className="text-gray-300 p-2 text-xl">âœ•</button>
                </div>
                {expandedImg === i.id && i.img && <img src={i.img} className="w-full rounded-[2.5rem] border-4 border-white shadow-2xl animate-fadeIn" />}
              </div>
            ))}
          </div>

          {showManage && (
            <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-6 animate-fadeIn">
              <div className="bg-white w-full max-w-[340px] rounded-[2.5rem] p-8 space-y-6 shadow-2xl overflow-hidden flex flex-col">
                <h3 className="text-2xl font-black text-slate-900">åˆ†é¡ç®¡ç†</h3>
                
                <div className="flex flex-nowrap gap-2 shrink-0 w-full">
                  <input 
                    value={newCat} 
                    onChange={e => setNewCat(e.target.value)} 
                    className="flex-1 min-w-0 bg-gray-50 border-2 border-gray-100 rounded-2xl px-4 py-4 font-black outline-none focus:border-[#750000] text-lg" 
                    placeholder="æ–°åˆ†é¡..." 
                  />
                  <button 
                    onClick={addNewCategory} 
                    className="shrink-0 w-16 bg-[#750000] text-white rounded-2xl font-black active:scale-95 transition-all flex items-center justify-center"
                  >
                    åŠ 
                  </button>
                </div>

                <div className="max-h-[250px] overflow-y-auto space-y-2 no-scrollbar py-2">
                  {categories.map(c => (
                    <div key={c} className="flex justify-between items-center p-4 bg-gray-50 rounded-2xl border border-gray-100">
                      <span className="font-black text-lg text-slate-700">{c}</span>
                      <button onClick={() => setCategories(categories.filter(x => x !== c))} className="text-gray-300 hover:text-red-500 p-1 text-xl">âœ•</button>
                    </div>
                  ))}
                </div>
                
                <button onClick={() => setShowManage(false)} className="w-full py-4 bg-gray-100 font-black rounded-2xl text-slate-500 text-lg active:bg-gray-200 transition-colors">å®Œæˆ</button>
              </div>
            </div>
          )}
        </div>
      );
    };

    // --- ä¸»ç¨‹å¼ App ---
    const App = () => {
      const [tab, setTab] = useState('home');
      const [itinerary, setItinerary] = useState(() => {
        const saved = localStorage.getItem('kansai_itinerary');
        return saved ? JSON.parse(saved) : INITIAL_ITINERARY;
      });
      const [personal, setPersonal] = useState(() => JSON.parse(localStorage.getItem('kansai_shopping_personal') || '[]'));
      const [proxy, setProxy] = useState(() => JSON.parse(localStorage.getItem('kansai_shopping_proxy') || '[]'));
      const [cats, setCats] = useState(() => {
        const saved = localStorage.getItem('kansai_shopping_categories');
        return saved ? JSON.parse(saved) : ["è—¥å¦åº—", "è¶…å¸‚"];
      });

      useEffect(() => localStorage.setItem('kansai_itinerary', JSON.stringify(itinerary)), [itinerary]);
      useEffect(() => localStorage.setItem('kansai_shopping_personal', JSON.stringify(personal)), [personal]);
      useEffect(() => localStorage.setItem('kansai_shopping_proxy', JSON.stringify(proxy)), [proxy]);
      useEffect(() => localStorage.setItem('kansai_shopping_categories', JSON.stringify(cats)), [cats]);

      return (
        <div className="flex flex-col h-full w-full max-w-md mx-auto bg-[#F9FAFB] relative overflow-hidden shadow-2xl">
          <main className="flex-1 overflow-y-auto no-scrollbar">
            {tab === 'home' && <HomeView itinerary={itinerary} />}
            {tab === 'schedule' && <ScheduleView itinerary={itinerary} onUpdate={setItinerary} />}
            {tab === 'shopping' && <ShoppingView personal={personal} proxy={proxy} setPersonal={setPersonal} setProxy={setProxy} categories={cats} setCategories={setCats} />}
          </main>
          <TabBar activeTab={tab} onTabChange={setTab} />
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
